{
  "_id"  : "settings",
  "type" : "control_template",
  'body' : """
<h1>Settings</h1>
<table data-role="table" id="settings-table" data-mode="columntoggle" class="ui-body-d ui-shadow table-stripe ui-responsive settings" data-column-btn-theme="b" data-column-btn-text="Columns to display..." data-column-popup-theme="a">
  <thead>
    <tr>
      <th>Database Name</th>
      <th>Variables</th>
      <th>Available Commands</th>
      <th>Listeners</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
""",
  'script' : """
    function addDataBaseRow(db_name) {
       var $newRow = $('<tr/>')
          .append($('<th/>').append(db_name))
          .append($('<td/>').addClass("settings variables loading"))
          .append($('<td/>').addClass("settings commands loading"))
          .append($('<td/>').addClass("settings listeners loading"));
       $('#settings-table tbody').append($newRow).trigger('create');
       return $newRow;
    }

    function handle_all_dbs(all_dbs) {
       function get_vars_for_db($row) {
         return function(keys) {
           $row.data( { all_vars : keys } );
           $row.find('.variables')
               .append(keys.join(", "))
               .removeClass('loading');
         };
       }
       function get_cmds_for_db($row) {
         return function(keys) {
           $row.data( { cmds : keys } );
           $row.find('.commands').append(keys.map(function(o) { return o.key; }).join(", "));
           $row.find('.commands,.listeners').removeClass('loading');
         };
       }

       for (var kk in all_dbs) {
         var $nR = addDataBaseRow(all_dbs[kk].prettyname);
         var d = 'nedm%2F' + kk;
         nedm.get_database(d).getVariableNames( get_vars_for_db( $nR ) );
         nedm.get_database(d).getCommands( get_cmds_for_db( $nR ) );
       }
    }
    function refresh_all() {
      nedm.get_database_info( handle_all_dbs );
    }

    nedm.page.once("load", function() {
      refresh_all();
    });
"""
}
